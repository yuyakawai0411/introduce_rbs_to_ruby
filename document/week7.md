## 目次

1. 型システムが導入された背景
   1. 導入背景
   2. 求めること
2. 型システムの関係性
   1. TypeProf と Steep の違い
   2. Sorbet とは
3. まとめ

## 型システムが導入された背景

[RubyKaigi2016](https://rubykaigi.org/2016/presentations/yukihiro_matz.html)で Matz が Ruby3.0 に型システムを導入することを決定した。

### 導入背景

アプリケーションを実装する際に、静的型付け言語を選択するプログラマーが増えた。<br>
その理由は、プログラマーが静的型付言語と比べて動的型付け言語の以下の点を懸念しているため

- プログラムを実行するまでエラーに気づけない
- カバレッジを高くすることが難しい
  - 実行時に型が決まるため、テストの書き忘れ等により、エラーを見落とすことがある
  - 主にテストや動作検証でカバレッジを高くする必要がある
- コードリーディングに時間がかかる
  - 型注釈がないことにより、どのような構造のデータを扱うかが読み取りにくい
  - yard 等を使って型注釈を書くことがあるほど

### 求めること

型システムを導入するのには賛成だが、ダックタイピング、DRY の概念は崩したくない。<br>
その理由は、プログラムする時に考えなければならないことを極力減らしたいという思想から

- 静的型付言語のようなクラス定義に依存する型システム(公称型)にしたくない
  - クラスの関係性を考えながらプログラミングしたくない
  - ダックタイピング(振る舞いに対してプログラミング)を阻害することになるため
- 静的型解析を導入したい
  - 動的な解析だとテストを書かなくてはいけない
  - 極力テストは書きたくない。DRY でないから
- 型注釈を書きたくない
  - 型注釈を書かなくても ruby は正常に動作している。改めて型注釈を書くのは DRY でないから
  - 将来的に型注釈は不要になると思っているから(プログラムが全て推論してくれる)
- IDE のサポートを強化したい
  - 型注釈の表示、関数ジャンプ、エラーの可視化等の開発体験向上はエンジニアが最も期待していることである

## 型システムの関係性

型システムとして、RBS、TypeProf、Steep を提供しており、以下のような使い方を想定している。<br>
型情報を型検査以外にも使う試みがいくつか存在する。

1. RBS で型注釈を書く
2. Ruby コードから TypeProf で型推論を行い RBS を生成する
3. 上記で生成した RBS をプログラマーが修正する
4. RBS を元に Steep で型検査を行う

[![Image from Gyazo](https://i.gyazo.com/4dd1110b6d30fe475314f51ef9f35408.png)](https://gyazo.com/4dd1110b6d30fe475314f51ef9f35408)

[参考文献: 型システムの利用想定](https://www.slideshare.net/mametter/type-profiler-ambitious-type-inference-for-ruby-3-238384550)

### TypeProf と Steep の違い

#### 役割

- TypeProf は、Ruby コードから型推論を行い、RBS を生成する機能がメイン。素朴な型検査(エラーの可能性があるところを指摘)も行なっているとのこと
- Steep は、 RBS を元に型検査する機能がメイン

#### 型検査の違い

- TypeProf は、 型レベルでプログラムを実行(抽象解釈)し、推論しながら素朴な型検査を行う
  - Steep と比べて実行時間が長い(プログラムを実行するため)
  - Steep と比べて型検査の正確性は劣るが、型注釈がないところも型検査をしてくれる(エントリーポイントの実装に依存するため)
- Steep は、型注釈を参照し、メソッド単位で型検査を行う
  - TypeProf と比べて実行時間が短い
  - TypeProf と比べて型検査の正確性が高いが、型注釈がなければ型検査を行わない

[![Image from Gyazo](https://i.gyazo.com/f54802b7e1b472268afced5c3a1fd8bf.png)](https://gyazo.com/f54802b7e1b472268afced5c3a1fd8bf)

[![Image from Gyazo](https://i.gyazo.com/407e5bc7b160a56ee915169a8b05e133.png)](https://gyazo.com/407e5bc7b160a56ee915169a8b05e133)

[参考文献: 型検査の違い](https://www.slideshare.net/mametter/typeprof-for-ide-enrich-development-experience-without-annotations)

上記のことから IDE のサポート機能も少し異なる。<br>
https://www.youtube.com/watch?v=UitqAvgmX0Y&t=3s

### Sorbet とは

RBS、Steep を組み合わせたようなサービスで型注釈と型検査の機能を提供する。<br>

- Ruby コードにコメントで型注釈をつける(RBS の方がメタプログラミング等に対して型注釈をかける機能が揃っている)
- 公称型のため、ダックタイピングには型注釈をかけない
- C++で実装されているため実行速度が早い(Steep は Ruby で実装されている)

[![Image from Gyazo](https://i.gyazo.com/d2955daf789bf99c2f1eb204601f9e43.png)](https://gyazo.com/d2955daf789bf99c2f1eb204601f9e43)

[参考文献: Sorbet との違い](https://speakerdeck.com/soutaro/ruby-programming-with-type-checking?slide=5)

## まとめ

- 型注釈は積極的に書いた方がいい
  - 型注釈があることで、IDE のサポートが充実したり、静的型付けが行える
  - 将来的に型注釈による型情報は、型検査以外にも使用される可能性がある
- 型注釈を自動生成するために、テストカバレッジを高く保つこと、gem は型注釈のあるものを採用することが重要
  - テストカバレッジが高いと、型推論でより正確な型注釈を自動生成できる
- 型注釈や型推論ができないコードはなるべく避けること
  - 型注釈ができない
    - メタプログラミング(RBS に用意されていない定義)
    - モンキーパッチ
  - 型推論ができない
    - send メソッド
